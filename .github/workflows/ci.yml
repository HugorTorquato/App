name: CI - Build and Test

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    steps:
      # -----------------------------
      # Checkout repository
      # -----------------------------
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive  # ensures vendor/crow is included

      # -----------------------------
      # Set up Docker Buildx
      # -----------------------------
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # -----------------------------
      # Build development image
      # Includes compilers, cmake, g++, GTest, Crow, etc.
      # -----------------------------
      - name: Build backend (dev stage)
        run: |
          docker build \
            -f backend/Dockerfile \
            --target build \
            -t condo_backend_dev .

      # -----------------------------
      # Run Google Tests
      # Uses the same image to ensure environment parity
      # -----------------------------
      - name: Run Google Tests
        run: |
          docker run --rm -w /app/backend/build condo_backend_dev ctest --output-on-failure

      - name: Generate Coverage Report
        run: |
          docker run --rm -v ${{ github.workspace }}:/app condo_backend_dev bash -c "
            cd backend/build &&
            lcov --directory . --capture --output-file coverage.info &&
            lcov --remove coverage.info '/usr/*' '/vendor/*' --output-file coverage.info &&
            genhtml coverage.info --output-directory coverage_html
          "
      - name: Upload Coverage Report as Artifact
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: backend/build/coverage_html

      # -----------------------------
      # Build production image
      # Smaller, minimal runtime layer only
      # -----------------------------
      - name: Build production image
        run: |
          docker build \
            -f backend/Dockerfile \
            --target runtime \
            -t condo_backend_prod .

      # -----------------------------
      # (Optional) Upload build artifacts
      # Useful if you want to inspect the runtime binary later
      # -----------------------------
      # - name: Save production image artifact
      #   uses: ishworkh/docker-image-artifact-upload@v1
      #   with:
      #     image: condo_backend_prod
